syntax = "proto3";

package feature.v1;

option go_package = "github.com/blcvn/kratos-proto/go/feature;feature";
option java_package = "com.blcvn.kratos.protos.feature";

import "feature/base.proto";
import "google/protobuf/struct.proto";

// =======================
// Feature Service Definition
// =======================
service FeatureService {
  // Create Feature
  rpc CreateFeature (CreateFeatureRequest) returns (FeatureReply);

  // Update Feature
  rpc UpdateFeature (UpdateFeatureRequest) returns (FeatureReply);

  // Get Feature
  rpc GetFeature (GetFeatureRequest) returns (FeatureReply);
  
  // List Features (Children of a parent or project root)
  rpc ListFeatures (ListFeaturesRequest) returns (ListFeaturesReply);
  
  // Delete Feature
  rpc DeleteFeature (DeleteFeatureRequest) returns (FeatureReply);

  // Document Management
  rpc CreateDoc (CreateDocRequest) returns (FeatureDoc);
  rpc ListDocs (ListDocsRequest) returns (ListDocsReply);
  rpc GetDocContent (GetDocContentRequest) returns (DocContentReply);
  rpc UpdateDocContent (UpdateDocContentRequest) returns (DocContentReply);

  // Chat Management
  rpc GetChatHistory (GetChatHistoryRequest) returns (ChatHistoryReply);
  rpc SendMessage (SendMessageRequest) returns (ChatMessage);
}

// =======================
// Domain Models
// =======================

message FeatureProgress {
  int32 discovery = 1;
  int32 analysis = 2;
  int32 documentation = 3;
  int32 usecase = 4;
  int32 visualization = 5;
  int32 validation = 6;
  int32 publish = 7;
  int32 overall = 8;
}

message FeatureArtifacts {
  google.protobuf.Struct discovery = 1;
  google.protobuf.Struct brd = 2;
  google.protobuf.Struct urd = 3;
  google.protobuf.Struct srs = 4;
  repeated google.protobuf.Struct usecase = 5;
  google.protobuf.Struct diagrams = 6;
  google.protobuf.Struct validation = 7;
}

message FeatureData {
  google.protobuf.Struct requirements = 1;
  repeated google.protobuf.Struct use_cases = 2;
  repeated google.protobuf.Struct answers = 3;
  repeated google.protobuf.Struct conversation_history = 4;
  repeated string skipped_questions = 5;
}

message FeatureDoc {
  string id = 1;
  string feature_id = 2;
  string doc_type = 3; // PRD, BRD, etc.
  int32 version = 4;
  string created_at = 5;
  string updated_at = 6;
}

message DocContent {
  string id = 1;
  string doc_id = 2;
  string content_type = 3; // index, outline, detail
  string status = 4; // NOT_DONE, PROCESSING, CREATED, APPROVED
  google.protobuf.Struct content = 5;
  string agent_task_id = 6;
  string updated_at = 7;
}

message ChatMessage {
  string id = 1;
  string feature_id = 2;
  google.protobuf.Struct message = 3; // {"role": "user", "content": "..."}
  string created_at = 4;
}

message Feature {
  string id = 1;
  string project_id = 2;
  string parent_id = 3; // Empty string if no parent
  string name = 4;
  string description = 5;
  int32 order = 6;
  string status = 7; // active, paused, completed, archived
  string current_phase = 8; // discovery, analysis, etc.
  string current_step = 9;
  google.protobuf.Struct progress = 10;
  google.protobuf.Struct artifacts = 11;
  google.protobuf.Struct data = 12;
  string created_at = 13;
  string updated_at = 14;
  repeated Feature children = 15;
}

// =======================
// Requests & Payloads
// =======================

message CreateFeaturePayload {
  string project_id = 1;
  string parent_id = 2;
  string name = 3;
  string description = 4;
}

message CreateFeatureRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  CreateFeaturePayload payload = 3;
}

message UpdateFeaturePayload {
  string id = 1;
  string name = 2;
  string description = 3;
  string status = 4;
  string current_phase = 5;
  string current_step = 6;
  google.protobuf.Struct progress = 7;
  google.protobuf.Struct artifacts = 8;
  google.protobuf.Struct data = 9;
}

message UpdateFeatureRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  UpdateFeaturePayload payload = 3;
}

message GetFeatureRequest {
  string id = 1;
}

message ListFeaturesPayload {
  string project_id = 1;
  string parent_id = 2; // Optional, to list children of a feature
  string status = 3;
  string search = 4;
}

message ListFeaturesRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  Pagination pagination = 3;
  ListFeaturesPayload payload = 4;
}

message DeleteFeatureRequest {
  string id = 1;
  Metadata metadata = 2;
  Signature signature = 3;
}

// =======================
// Document Requests
// =======================

message CreateDocPayload {
  string feature_id = 1;
  string doc_type = 2;
}

message CreateDocRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  CreateDocPayload payload = 3;
}

message ListDocsPayload {
  string feature_id = 1;
}

message ListDocsRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  ListDocsPayload payload = 3;
}

message GetDocContentPayload {
  string doc_id = 1;
  string content_type = 2;
}

message GetDocContentRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  GetDocContentPayload payload = 3;
}

message UpdateDocContentPayload {
  string doc_id = 1;
  string content_type = 2;
  google.protobuf.Struct content = 3;
  string status = 4;
  string agent_task_id = 5;
}

message UpdateDocContentRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  UpdateDocContentPayload payload = 3;
}

// =======================
// Chat Requests
// =======================

message GetChatHistoryPayload {
  string feature_id = 1;
  string before = 2; // Timestamp for pagination
  int32 limit = 3;
}

message GetChatHistoryRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  GetChatHistoryPayload payload = 3;
}

message SendMessagePayload {
  string feature_id = 1;
  google.protobuf.Struct message = 2;
}

message SendMessageRequest {
  Metadata metadata = 1;
  Signature signature = 2;
  SendMessagePayload payload = 3;
}

// =======================
// Responses
// =======================

message FeatureReply {
  Result result = 1;
  Feature payload = 2;
}

message ListFeaturesReply {
  Result result = 1;
  Pagination pagination = 2;
  repeated Feature payload = 3;
}

message ListDocsReply {
  Result result = 1;
  repeated FeatureDoc payload = 2;
}

message DocContentReply {
  Result result = 1;
  DocContent payload = 2;
}

message ChatHistoryReply {
  Result result = 1;
  string next_cursor = 2;
  repeated ChatMessage payload = 3;
}
